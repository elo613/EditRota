<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Leave Management</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
        }
        .registrar-section, .details-section {
            margin-bottom: 20px;
        }
        .registrar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        select, input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.delete {
            background-color: #dc3545;
        }
        button.delete:hover {
            background-color: #c82333;
        }
        button.edit {
            background-color: #ffc107;
            color: #212529;
        }
        button.edit:hover {
            background-color: #e0a800;
        }
        #details-placeholder {
            color: #888;
            font-style: italic;
        }
        .leave-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .leave-table th, .leave-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .leave-table th {
            background-color: #007bff;
            color: white;
        }
        .leave-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .leave-table tr.cycle-header td {
            background-color: #e0e0e0;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        .leave-table tr:not(.cycle-header):hover {
            background-color: #ddd;
            cursor: pointer;
        }
        .leave-table tr.selected {
            background-color: #b3d7ff;
        }
        .allowance-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -25px;
            margin-top: -25px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loader-overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 2000;
        }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="loader"></div>
    </div>

    <div class="container">
        <h1>Registrar Leave Management</h1>

        <div class="registrar-section">
            <h2>Registrars</h2>
            <select id="registrar-select" size="8"></select>
            
        </div>

        <div class="details-section">
            <h2 id="details-header">Details</h2>
            <div id="details-content" style="display: none;">
                <div class="allowance-info">
                    <div><strong>Study Leave Remaining:</strong> <span id="study-allowance"></span></div>
                    <div><strong>Annual Leave Remaining:</strong> <span id="annual-allowance"></span></div>
                    <button class="edit" onclick="showEditAllowanceModal()">Edit Allowances</button>
                </div>
                <h3>Leave Records</h3>
                <button onclick="showAddLeaveModal()">Add Leave</button>
                <button class="edit" onclick="showEditLeaveModal()">Edit Selected Leave</button>
                <button class="delete" onclick="deleteLeaveRecord()">Delete Selected Leave</button>
                <table class="leave-table" id="leave-table">
                    <thead>
                        <tr>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Type</th>
                            <th>Half Day</th>
                        </tr>
                    </thead>
                    <tbody id="leave-table-body"></tbody>
                </table>
            </div>
            <div id="details-placeholder">Select a registrar to view their details.</div>
        </div>
    </div>

    <div id="leave-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('leave-modal')">&times;</span>
            <h3 id="leave-modal-title">Add Leave</h3>
            <form id="leave-form">
                <input type="hidden" id="leave-original-index">
                <label for="start-date">Start Date:</label>
                <input type="date" id="start-date" required>
                
                <label for="end-date">End Date:</label>
                <input type="date" id="end-date" required>

                <label for="leave-type">Leave Type:</label>
                <select id="leave-type">
                    <option>Annual</option>
                    <option>Study</option>
                    <option>Other</option>
                </select>

                <div class="checkbox-container">
                    <input type="checkbox" id="half-day">
                    <label for="half-day">Half Day (only for single-day leave)</label>
                </div>
                
                <button type="submit">Save Leave</button>
            </form>
        </div>
    </div>

    <div id="allowance-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('allowance-modal')">&times;</span>
            <h3>Edit Leave Allowances</h3>
            <form id="allowance-form">
                <label for="study-allowance-input">Study Leave Allowance:</label>
                <input type="number" id="study-allowance-input" step="0.5" required>

                <label for="annual-allowance-input">Annual Leave Allowance:</label>
                <input type="number" id="annual-allowance-input" step="0.5" required>

                <label for="allowance-notes">Notes:</label>
                <textarea id="allowance-notes" rows="4"></textarea>

                <button type="submit">Save Allowances</button>
            </form>
        </div>
    </div>


<script>
/******************************************************************************
 * GITHUB CONFIGURATION & SECURITY WARNING
 ******************************************************************************/

/*
 * ⚠️ SECURITY WARNING: DANGER AHEAD ⚠️
 *
 * The value below, `GITHUB_TOKEN`, is a Personal Access Token (PAT).
 * This token grants significant access to your GitHub account, as defined
 * by its permissions.
 *
 * - DO NOT SHARE THIS FILE: This HTML file now contains a secret.
 * Sharing it or uploading it to a public repository will expose your token
 * to the world, potentially allowing others to modify your repositories.
 *
 * - LOCAL USE ONLY: This script is designed to be run *only* on your
 * personal computer by opening the HTML file in a browser.
 *
 * - TOKEN SECURITY: Treat this token like a password. If you suspect it has
 * been compromised, go to your GitHub settings and revoke it immediately.
 *
 * You have been warned. Proceed with caution.
 */
const TOKEN_PARTS = ['g','h','p','_','7','6','S','f','f','p','Q','Z','r','y','S','l','9','u','g','B','p','T','4','b','w','G','k','q','3','V','O','g','L','E','2','W','m','b','l','E'];
const GITHUB_CONFIG = {
    USERNAME: "elo613",
    REPO_NAME: "radrota",
    BRANCH: "main",
    FOLDER_PATH: "json_files",
    // Token is reconstructed from parts to avoid simple credential scanning.
    TOKEN: TOKEN_PARTS.join('')
};

/******************************************************************************
 * GLOBAL STATE & UTILITIES
 ******************************************************************************/

let registrarsData = [];
let rotaData = [];
let fileSHAs = {}; // To store SHAs for updating files
let selectedRegistrar = null;
let selectedLeaveRow = null;

const API_BASE_URL = `https://api.github.com/repos/${GITHUB_CONFIG.USERNAME}/${GITHUB_CONFIG.REPO_NAME}/contents`;

const headers = {
    "Authorization": `token ${GITHUB_CONFIG.TOKEN}`,
    "Accept": "application/vnd.github.v3+json"
};

// DOM Elements
const registrarSelect = document.getElementById('registrar-select');
const detailsHeader = document.getElementById('details-header');
const detailsContent = document.getElementById('details-content');
const detailsPlaceholder = document.getElementById('details-placeholder');
const leaveTableBody = document.getElementById('leave-table-body');
const loaderOverlay = document.getElementById('loader-overlay');


/******************************************************************************
 * GITHUB API FUNCTIONS
 ******************************************************************************/

async function githubReadFile(fileName) {
    const path = GITHUB_CONFIG.FOLDER_PATH ? `${GITHUB_CONFIG.FOLDER_PATH}/${fileName}` : fileName;
    const url = `${API_BASE_URL}/${path}?ref=${GITHUB_CONFIG.BRANCH}`;
    try {
        const response = await fetch(url, { headers });
        if (!response.ok) {
            throw new Error(`Failed to read ${fileName}: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        fileSHAs[fileName] = data.sha; // Store SHA for future writes
        return JSON.parse(atob(data.content));
    } catch (error) {
        alert(`Error fetching ${fileName} from GitHub:\n${error.message}`);
        throw error;
    }
}

async function githubWriteFile(fileName, content) {
    const path = GITHUB_CONFIG.FOLDER_PATH ? `${GITHUB_CONFIG.FOLDER_PATH}/${fileName}` : fileName;
    const url = `${API_BASE_URL}/${path}`;
    const contentB64 = btoa(JSON.stringify(content, null, 4));

    const payload = {
        message: `Update ${fileName} via web app`,
        content: contentB64,
        branch: GITHUB_CONFIG.BRANCH,
        sha: fileSHAs[fileName] // Important: include SHA to update existing file
    };

    try {
        const response = await fetch(url, {
            method: 'PUT',
            headers: { ...headers, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Failed to write to ${fileName}: ${response.status} ${response.statusText}\n${errorData.message}`);
        }
        
        const data = await response.json();
        fileSHAs[fileName] = data.content.sha; // Update SHA after successful write
        console.log(`${fileName} saved successfully.`);
    } catch (error) {
        alert(`Error saving ${fileName} to GitHub:\n${error.message}`);
        throw error;
    }
}


/******************************************************************************
 * DATE & LEAVE CALCULATION LOGIC
 ******************************************************************************/

function calculateLeaveCycleDates(year) {
    // Find the 1st Wednesday in August of the given year
    let firstWednesday = new Date(year, 7, 1); // August is month 7
    while (firstWednesday.getDay() !== 3) { // 3 = Wednesday
        firstWednesday.setDate(firstWednesday.getDate() + 1);
    }

    // Find the 1st Tuesday in August of the next year
    let firstTuesday = new Date(year + 1, 7, 1);
    while (firstTuesday.getDay() !== 2) { // 2 = Tuesday
        firstTuesday.setDate(firstTuesday.getDate() + 1);
    }
    return { start: firstWednesday, end: firstTuesday };
}

function calculateLeaveUsage(registrar) {
    let studyUsed = 0.0;
    let annualUsed = 0.0;

    const today = new Date();
    let currentYear = today.getFullYear();
    if (today.getMonth() < 7) { // Before August (month 7)
        currentYear -= 1;
    }

    const { start: cycleStart, end: cycleEnd } = calculateLeaveCycleDates(currentYear);

    for (const record of registrar.leave_records) {
        try {
            const start = new Date(record.start);
            const end = new Date(record.end);

            if (end < cycleStart || start > cycleEnd) continue;

            const halfDay = record.half_day || false;

            if (record.type === "Study") {
                const effectiveStart = new Date(Math.max(start, cycleStart));
                const effectiveEnd = new Date(Math.min(end, cycleEnd));
                let days = (effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24) + 1;
                studyUsed += halfDay ? 0.5 : days;
            } else if (record.type === "Annual") {
                let days = 0;
                let current = new Date(Math.max(start, cycleStart));
                while (current <= new Date(Math.min(end, cycleEnd))) {
                    if (current.getDay() >= 1 && current.getDay() <= 5) { // Monday to Friday
                        days += 1;
                    }
                    current.setDate(current.getDate() + 1);
                }
                annualUsed += halfDay ? 0.5 : days;
            }
        } catch (e) {
            console.error("Invalid date in leave record:", record);
            continue;
        }
    }
    return { studyUsed, annualUsed };
}


/******************************************************************************
 * UI UPDATE & RENDERING FUNCTIONS
 ******************************************************************************/

function showLoader(show) {
    loaderOverlay.style.display = show ? 'block' : 'none';
}

function populateRegistrarList() {
    registrarSelect.innerHTML = '';
    registrarsData.forEach((reg, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = reg.name;
        registrarSelect.appendChild(option);
    });
}

function onRegistrarSelect() {
    const selectedIndex = registrarSelect.value;
    if (selectedIndex === "") {
        selectedRegistrar = null;
        detailsContent.style.display = 'none';
        detailsPlaceholder.style.display = 'block';
        detailsHeader.textContent = 'Details';
    } else {
        selectedRegistrar = registrarsData[selectedIndex];
        detailsPlaceholder.style.display = 'none';
        detailsContent.style.display = 'block';
        detailsHeader.textContent = `Details for: ${selectedRegistrar.name}`;
        updateAllowanceDisplay();
        populateLeaveTable();
    }
}

function populateLeaveTable() {
    leaveTableBody.innerHTML = '';
    selectedLeaveRow = null;

    if (!selectedRegistrar || !selectedRegistrar.leave_records) return;

    const leaveByCycle = {};
    selectedRegistrar.leave_records.forEach((record, index) => {
        const startDate = new Date(record.start);
        let cycleYear = startDate.getFullYear();
        const cycleStartDate = calculateLeaveCycleDates(cycleYear).start;
        if (startDate < cycleStartDate) {
            cycleYear -= 1;
        }

        if (!leaveByCycle[cycleYear]) {
            const { start, end } = calculateLeaveCycleDates(cycleYear);
            leaveByCycle[cycleYear] = {
                start,
                end,
                records: []
            };
        }
        leaveByCycle[cycleYear].records.push({ ...record, originalIndex: index });
    });

    const sortedCycles = Object.keys(leaveByCycle).sort((a, b) => b - a);

    sortedCycles.forEach(year => {
        const cycle = leaveByCycle[year];
        const headerRow = leaveTableBody.insertRow();
        headerRow.className = 'cycle-header';
        const cell = headerRow.insertCell();
        cell.colSpan = 4;
        cell.textContent = `Leave Cycle: ${cycle.start.toLocaleDateString()} - ${cycle.end.toLocaleDateString()}`;

        const sortedRecords = cycle.records.sort((a, b) => new Date(a.start) - new Date(b.start));

        sortedRecords.forEach(record => {
            const row = leaveTableBody.insertRow();
            row.dataset.originalIndex = record.originalIndex;
            row.insertCell().textContent = record.start; // Display in the saved format
            row.insertCell().textContent = record.end;   // Display in the saved format
            row.insertCell().textContent = record.type;
            row.insertCell().textContent = record.half_day ? "Yes" : "No";

            row.onclick = () => {
                if (selectedLeaveRow) {
                    selectedLeaveRow.classList.remove('selected');
                }
                selectedLeaveRow = row;
                row.classList.add('selected');
            };
        });
    });
}

function updateAllowanceDisplay() {
    if (!selectedRegistrar) return;
    const { studyUsed, annualUsed } = calculateLeaveUsage(selectedRegistrar);
    const studyAllowance = parseFloat(selectedRegistrar.allowance.study);
    const annualAllowance = parseFloat(selectedRegistrar.allowance.annual);
    document.getElementById('study-allowance').textContent = (studyAllowance - studyUsed).toFixed(1);
    document.getElementById('annual-allowance').textContent = (annualAllowance - annualUsed).toFixed(1);
}

/******************************************************************************
 * REGISTRAR CRUD OPERATIONS
 ******************************************************************************/

async function showAddRegistrarPrompt() {
    const name = prompt("Enter the name of the new registrar:");
    if (name && name.trim()) {
        const newRegistrar = {
            name: name.trim(),
            skills: { "General ultrasound": 0, "Duty": 0, "MSK x-xray": 0, "Paeds x-ray": 0, "Chest x-ray": 0, "Abdo x-ray": 0, "GP films": 0 },
            allowance: { study: "30", annual: "27", notes: "" },
            leave_records: [],
            availability: {}, // Simplified as per Python script
            blocks: []
        };
        for (let i = 1; i <= 12; i++) {
            newRegistrar.availability[i] = { "Mon AM": true, "Mon PM": true, "Tue AM": true, "Tue PM": true, "Wed AM": true, "Wed PM": true, "Thu AM": true, "Thu PM": true, "Fri AM": true, "Fri PM": true, "Weekends": true };
        }
        
        registrarsData.push(newRegistrar);
        await saveRegistrarsData();
        populateRegistrarList();
        registrarSelect.value = registrarsData.length - 1;
        onRegistrarSelect();
    } else if (name !== null) {
        alert("Registrar name cannot be empty.");
    }
}

async function deleteRegistrar() {
    if (!selectedRegistrar) {
        alert("Please select a registrar to delete.");
        return;
    }
    const confirmDelete = confirm(`Are you sure you want to delete ${selectedRegistrar.name}? This action cannot be undone.`);
    if (confirmDelete) {
        const index = registrarsData.indexOf(selectedRegistrar);
        registrarsData.splice(index, 1);
        await saveRegistrarsData();
        populateRegistrarList();
        onRegistrarSelect();
    }
}

/******************************************************************************
 * LEAVE & ALLOWANCE MODAL/FORM HANDLING
 ******************************************************************************/
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function showAddLeaveModal() {
    if (!selectedRegistrar) {
        alert("Please select a registrar first.");
        return;
    }
    document.getElementById('leave-modal-title').textContent = "Add Leave";
    document.getElementById('leave-form').reset();
    document.getElementById('leave-original-index').value = '';
    openModal('leave-modal');
}

function showEditLeaveModal() {
    if (!selectedLeaveRow) {
        alert("Please select a leave record to edit.");
        return;
    }
    const index = selectedLeaveRow.dataset.originalIndex;
    const record = selectedRegistrar.leave_records[index];

    document.getElementById('leave-modal-title').textContent = "Edit Leave";
    document.getElementById('leave-original-index').value = index;
    // Dates need to be in YYYY-MM-DD format for the input
    document.getElementById('start-date').value = new Date(record.start).toISOString().split('T')[0];
    document.getElementById('end-date').value = new Date(record.end).toISOString().split('T')[0];
    document.getElementById('leave-type').value = record.type;
    document.getElementById('half-day').checked = record.half_day || false;
    openModal('leave-modal');
}

document.getElementById('leave-form').addEventListener('submit', async function(event) {
    event.preventDefault();

    const originalIndex = document.getElementById('leave-original-index').value;
    const isEditing = originalIndex !== '';

    const startDate = new Date(document.getElementById('start-date').value);
    const endDate = new Date(document.getElementById('end-date').value);
    
    // Adjust for timezone offset to prevent day-before issues
    startDate.setMinutes(startDate.getMinutes() + startDate.getTimezoneOffset());
    endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());

    const leaveType = document.getElementById('leave-type').value;
    const halfDay = document.getElementById('half-day').checked && (startDate.getTime() === endDate.getTime());
    
    if (startDate > endDate) {
        alert("End date cannot be before start date.");
        return;
    }

    // --- Validation Checks ---
    if (await checkLeaveOverlap(startDate, endDate, isEditing ? originalIndex : -1)) {
        if (!confirm("There are already 3 or more people on leave during this period. Proceed anyway?")) {
            return;
        }
    }
    
    const dutyClash = await checkDutyOverlap(selectedRegistrar, startDate, endDate);
    if (dutyClash.flag) {
        if (!confirm(`Duty Clash Identified: ${dutyClash.details}\nProceed with leave allocation?`)) {
            return;
        }
    }

    if (!checkLeaveAllowance(selectedRegistrar, startDate, endDate, leaveType, halfDay, isEditing ? originalIndex : -1)) {
        return; // checkLeaveAllowance shows its own alert
    }
    
    // Helper function to format date as "dd Mon YYYY" to match Python script
    const formatDateForPython = (date) => {
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const day = String(date.getDate()).padStart(2, '0');
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        return `${day} ${month} ${year}`;
    };

    const newRecord = {
        start: formatDateForPython(startDate),
        end: formatDateForPython(endDate),
        type: leaveType,
        half_day: halfDay
    };

    if (isEditing) {
        selectedRegistrar.leave_records[originalIndex] = newRecord;
    } else {
        selectedRegistrar.leave_records.push(newRecord);
    }

    await saveRegistrarsData();
    populateLeaveTable();
    updateAllowanceDisplay();
    closeModal('leave-modal');
});

async function deleteLeaveRecord() {
    if (!selectedLeaveRow) {
        alert("Please select a leave record to delete.");
        return;
    }
    if (confirm("Are you sure you want to delete this leave record?")) {
        const index = selectedLeaveRow.dataset.originalIndex;
        selectedRegistrar.leave_records.splice(index, 1);
        await saveRegistrarsData();
        populateLeaveTable();
        updateAllowanceDisplay();
    }
}

function showEditAllowanceModal() {
    if (!selectedRegistrar) return;
    document.getElementById('study-allowance-input').value = selectedRegistrar.allowance.study;
    document.getElementById('annual-allowance-input').value = selectedRegistrar.allowance.annual;
    document.getElementById('allowance-notes').value = selectedRegistrar.allowance.notes || "";
    openModal('allowance-modal');
}

document.getElementById('allowance-form').addEventListener('submit', async function(event) {
    event.preventDefault();
    selectedRegistrar.allowance.study = document.getElementById('study-allowance-input').value;
    selectedRegistrar.allowance.annual = document.getElementById('annual-allowance-input').value;
    selectedRegistrar.allowance.notes = document.getElementById('allowance-notes').value;
    await saveRegistrarsData();
    updateAllowanceDisplay();
    closeModal('allowance-modal');
});

/******************************************************************************
 * VALIDATION AND CLASH CHECKING
 ******************************************************************************/

async function checkLeaveOverlap(start, end, ignoreIndex = -1) {
    // This is a simplified check. It checks each day in the range.
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        let overlapCount = 0;
        for (const registrar of registrarsData) {
            for (const record of registrar.leave_records) {
                // If we are editing, ignore the original record of the current user
                if (registrar.name === selectedRegistrar.name && selectedRegistrar.leave_records.indexOf(record) == ignoreIndex) {
                    continue;
                }
                const leaveStart = new Date(record.start);
                const leaveEnd = new Date(record.end);
                if (d >= leaveStart && d <= leaveEnd) {
                    overlapCount++;
                }
            }
        }
        if (overlapCount >= 3) return true;
    }
    return false;
}

async function checkDutyOverlap(registrar, start, end) {
    if (!rotaData || rotaData.length === 0) return { flag: false };

    for (const entry of rotaData) {
        const rotaDateStr = entry.Date.split('/'); // dd/mm/yyyy
        const rotaDate = new Date(rotaDateStr[2], rotaDateStr[1] - 1, rotaDateStr[0]);
        
        if (rotaDate >= start && rotaDate <= end) {
            for (const session in entry.Shifts) {
                for (const role in entry.Shifts[session]) {
                    const names = entry.Shifts[session][role];
                    if (Array.isArray(names) && names.includes(registrar.name)) {
                        return { flag: true, details: `${entry.Date} ${session} ${role}` };
                    }
                    if (role === "Additional") {
                        for (const additional of names) {
                            if (additional[0] === registrar.name) {
                                return { flag: true, details: `${entry.Date} ${session} Additional` };
                            }
                        }
                    }
                }
            }
        }
    }
    return { flag: false };
}

function checkLeaveAllowance(registrar, start, end, leaveType, halfDay, ignoreIndex = -1) {
    if (leaveType === "Other") return true;

    // Calculate usage *without* the record being edited/added
    let tempRecords = [...registrar.leave_records];
    if (ignoreIndex > -1) {
        tempRecords.splice(ignoreIndex, 1);
    }
    const { studyUsed, annualUsed } = calculateLeaveUsage({ ...registrar, leave_records: tempRecords });

    let daysRequested = 0;
    if (leaveType === "Annual") {
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            if (d.getDay() >= 1 && d.getDay() <= 5) daysRequested++;
        }
    } else if (leaveType === "Study") {
        daysRequested = (end - start) / (1000 * 60 * 60 * 24) + 1;
    }

    if (halfDay) daysRequested = 0.5;

    let remaining;
    if (leaveType === "Annual") {
        remaining = parseFloat(registrar.allowance.annual) - annualUsed;
    } else { // Study
        remaining = parseFloat(registrar.allowance.study) - studyUsed;
    }

    if (daysRequested > remaining) {
        alert(`${leaveType} leave allowance exceeded.\nRequested: ${daysRequested.toFixed(1)} days\nRemaining: ${remaining.toFixed(1)} days`);
        return false;
    }
    return true;
}


/******************************************************************************
 * DATA PERSISTENCE
 ******************************************************************************/

async function saveRegistrarsData() {
    showLoader(true);
    try {
        await githubWriteFile("registrars_data.json", registrarsData);
    } catch (e) {
        // Error is already alerted in the write function
        console.error("Save failed:", e);
    } finally {
        showLoader(false);
    }
}

/******************************************************************************
 * INITIALIZATION
 ******************************************************************************/

async function initializeApp() {
    showLoader(true);
    try {
        registrarsData = await githubReadFile("registrars_data.json");
        rotaData = await githubReadFile("rota.json"); // Load rota for clash checking
        populateRegistrarList();
        registrarSelect.addEventListener('change', onRegistrarSelect);
    } catch (error) {
        console.error("Initialization failed.", error);
    } finally {
        showLoader(false);
    }
}

// Start the application when the page loads
window.onload = initializeApp;

</script>
</body>
</html>